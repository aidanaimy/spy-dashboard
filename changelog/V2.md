# SPY Trading Dashboard - Version 2.0

## System Overview

A rule-based trading signal generator for SPY 0DTE options, combining daily regime analysis, intraday momentum, volatility context, and time-of-day filters to produce high-quality CALL/PUT/NONE signals with confidence levels.

---

## Core Functionality

### 1. **Regime Analysis** (Daily Context)
- **Trend Classification**: 20D/50D moving average analysis â†’ Bullish/Bearish/Mixed
- **Gap Analysis**: Measures overnight gap vs. previous close (Small/Large thresholds)
- **Range Classification**: Intraday range as % of open (Low/Normal/High)
- **0DTE Permission**: ðŸš¦ RED/YELLOW/GREEN based on trend + gap + range
  - **RED**: Choppy conditions (small gap, low range) â†’ Avoid trading
  - **YELLOW**: Neutral conditions â†’ Proceed with caution
  - **GREEN**: Volatile conditions (large gap, high range) â†’ Favorable for 0DTE

### 2. **Intraday Analysis** (Real-Time Context)
- **VWAP**: Volume-weighted average price (resets each trading day at 9:30 AM ET)
- **EMA 9/21**: Exponential moving averages (carry over from previous day for continuity)
- **Micro Trend**: Up/Down/Neutral based on EMA crossovers and price vs. VWAP
- **Returns**: 1-bar and 5-bar percentage returns
- **Realized Volatility**: Short-term volatility calculation (20-bar lookback)
- **Distance from VWAP**: Current price deviation from VWAP

### 3. **Volatility Context** (Market Environment)
- **ATM IV**: At-the-money implied volatility from options chain
- **VIX Level**: Current VIX reading
- **VIX Rank**: VIX position within 252-day range (0-100%)
- **VIX Percentile**: Historical percentile of current VIX
- **Contextual Summary**: Plain-language interpretation (Calm/Normal/Elevated volatility)

### 4. **Signal Generation** (Rule-Based Logic)

#### Base Signal Rules:
- **CALL Signal**: Requires 3+ of:
  - Bullish daily trend
  - Micro trend up (EMA 9 > EMA 21, price > VWAP)
  - Price above VWAP
  - Positive 5-bar return
  
- **PUT Signal**: Requires 3+ of:
  - Bearish daily trend
  - Micro trend down (EMA 9 < EMA 21, price < VWAP)
  - Price below VWAP
  - Negative 5-bar return

- **Confidence Levels**:
  - **HIGH**: 4 matching conditions
  - **MEDIUM**: 3 matching conditions
  - **LOW**: 2 matching conditions
  - **NONE**: < 2 matching conditions

---

## Filter Stack (Applied in Order)

### 1. **Chop Detector** (Data-Driven)
Detects ranging/choppy market conditions using 4 criteria:
- **VWAP Crosses**: > 3 crosses in last hour
- **Flat EMAs**: Both EMA 9 and EMA 21 slopes < 0.1%
- **Low ATR**: ATR(14) < 0.2% of price
- **Tight VWAP Range**: Price within VWAP Â± 0.2%

**Action**: If 2+ criteria met â†’ Set to NONE or reduce confidence to LOW

### 2. **Time-of-Day Filters** (Session-Aware)
- **First 10 Minutes (9:45-9:55 AM)**: Reduce confidence by 50% (volatile open)
- **Lunch Period (12:00-1:00 PM)**: Reduce confidence by 40% (lower quality)
- **Power Hour (2:30-3:30 PM)**: Increase confidence by 20% (strong moves)
- **Late-Day Cutoff (3:30 PM+)**: Block all signals (too close to close)

### 3. **Market Phase Gating** (Off-Hours Protection)
- **Pre-Market**: Block all signals â†’ NONE
- **After Hours**: Block all signals â†’ NONE
- **Regular Hours**: Signals allowed (9:30 AM - 4:00 PM ET)

### 4. **Environment Filters** (Regime + Volatility)
- **0DTE Permission**:
  - RED â†’ Force confidence to LOW (even if signal exists)
  - GREEN â†’ Boost MEDIUM to HIGH
  
- **IV/VIX Context**:
  - Low IV (< 15) + Low VIX (< 15) â†’ Reduce MEDIUM to LOW
  - High IV (> 20) or High VIX (> 20) â†’ Boost MEDIUM to HIGH

---

## Data Flow

```
1. Data Fetching (Alpaca â†’ yfinance fallback)
   â”œâ”€ Daily bars (80-day lookback, cached 5 min)
   â””â”€ Intraday bars (5-min, last 2 days, cached 30 sec)
      â””â”€ Filtered to regular hours only (9:30 AM - 4:00 PM ET)

2. Regime Calculation
   â”œâ”€ Calculate 20D/50D MAs
   â”œâ”€ Measure gap vs. yesterday's close
   â”œâ”€ Calculate today's range
   â””â”€ Determine 0DTE permission (RED/YELLOW/GREEN)

3. Intraday Analysis
   â”œâ”€ Calculate VWAP (resets daily)
   â”œâ”€ Calculate EMA 9/21 (carries over from yesterday)
   â”œâ”€ Determine micro trend
   â”œâ”€ Calculate returns & volatility
   â””â”€ Measure distance from VWAP

4. Volatility Context
   â”œâ”€ Fetch ATM IV from options chain
   â”œâ”€ Fetch VIX level & calculate rank/percentile
   â””â”€ Generate plain-language summary

5. Signal Generation
   â”œâ”€ Base signal (CALL/PUT/NONE + confidence)
   â”œâ”€ Apply chop detector â†’ Adjust if choppy
   â”œâ”€ Apply time filters â†’ Adjust confidence/block
   â”œâ”€ Apply market phase gate â†’ Block off-hours
   â””â”€ Apply environment filters â†’ Final confidence adjustment

6. Output
   â”œâ”€ Signal direction (CALL/PUT/NONE)
   â”œâ”€ Confidence (HIGH/MEDIUM/LOW)
   â””â”€ Human-readable rationale
```

---

## Performance Characteristics

### Data Refresh
- **Auto-refresh**: Every 30 seconds (configurable)
- **Intraday cache**: 30-second TTL
- **Daily cache**: 5-minute TTL
- **IV context cache**: 1-hour TTL

### Data Sources
- **Primary**: Alpaca API (IEX feed, free tier)
- **Fallback**: yfinance (if Alpaca unavailable)
- **Rate Limits**: 200 requests/min (Alpaca free tier) - well within limits with caching

### Trading Hours
- **Active Session**: 9:30 AM - 4:00 PM ET (regular trading hours only)
- **Signal Window**: 9:45 AM - 3:30 PM ET (avoids first 15 min and last 30 min)
- **Pre-market/After-hours**: Blocked (no signals generated)

### Indicator Behavior
- **VWAP**: Resets each trading day (calculated from 9:30 AM - 4:00 PM ET)
- **EMA 9/21**: Continuous across days (carries over last value from previous day)
- **All indicators**: Only use regular trading hours data (excludes pre-market/after-hours)

---

## Key Features

### Real-Time Monitoring
- **Live data**: 5-minute bars, updates every 30 seconds
- **Discord notifications**: Alerts when signal direction/confidence changes
- **24/7 operation**: Runs on Streamlit Cloud, monitors market continuously

### Dashboard UI/UX
- **Unified card design**: All cards use consistent styling with CSS Grid layout
- **Equal-width cards**: Signal and Rationale sections match Today's Regime card widths
- **Contextual summaries**: Each regime card dynamically generates plain-language summaries:
  - **Trend Bias**: Explains trend strength (strong/moderate/weak) and momentum direction
  - **Gap & Range**: Describes gap direction/magnitude and range characteristics
  - **0DTE Permission**: Provides actionable guidance based on permission status
  - **Volatility Context**: Interprets IV/VIX levels in plain language
- **Color-coded borders**: 
  - **Dynamic colors**: Trend Bias (green/red/yellow), 0DTE Permission (red/yellow/green), Signal (green/red/grey)
  - **Neutral grey**: Gap & Range, Volatility Context, Overview, Rationale Breakdown
- **Improved spacing**: Optimized padding and margins for better readability

### Signal Quality
- **Multi-layer filtering**: Chop detection + time filters + regime permission + volatility context
- **Confidence adjustment**: Dynamic confidence based on market conditions
- **Rationale breakdown**: Human-readable explanation for each signal
- **Contextual summaries**: Each regime card includes a dynamic summary sentence explaining current conditions

### Trade Journal
- **Manual logging**: Log trades with timestamp, direction, bias, size, prices, notes
- **System adherence tracking**: Tag trades as "with-system" or "against-system"
- **P/L analysis**: Track total P/L, system-aligned P/L, and system-opposed P/L
- **Delete functionality**: Remove incorrect entries

### Backtesting
- **Historical replay**: Uses same signal logic as live dashboard
- **VIX context**: Includes historical VIX data for accurate confidence adjustments
- **Metrics**: Trades, win rate, avg R-multiple, max drawdown, equity curve
- **Date range**: Flexible (tested up to 60+ trading days)

---

## Signal Quality Improvements (V2)

### What Makes Signals Better:
1. **Chop Detection**: Eliminates false signals during ranging markets
2. **Time-of-Day Filters**: Avoids low-quality periods (open volatility, lunch chop, late-day)
3. **0DTE Permission**: Only trades when conditions are favorable
4. **Volatility Context**: Adjusts confidence based on IV/VIX regime
5. **Market Phase Gating**: Prevents signals during off-hours
6. **EMA Continuity**: More accurate trend analysis with cross-day EMA carryover

### Confidence Hierarchy:
- **HIGH**: Strong setup + favorable environment (GREEN permission, high IV, power hour)
- **MEDIUM**: Good setup + neutral environment
- **LOW**: Weak setup or unfavorable environment (RED permission, low IV, chop detected)

---

## Limitations & Considerations

### Data Limitations:
- **5-minute bars**: Fastest granularity (not 1-minute)
- **Free tier**: Alpaca IEX feed (sufficient for 5-min bars)
- **Historical IV**: ATM IV not available for backtests (VIX used as proxy)

### Signal Limitations:
- **No position sizing**: Signals indicate direction/confidence, not size
- **No strike selection**: Does not recommend specific strikes or expirations
- **No exit timing**: Signals indicate entry bias, not exit points
- **Manual execution**: All trades must be executed manually in your broker

### Backtest Limitations:
- **Price-only**: Simulates price moves, not actual options pricing
- **Fixed TP/SL**: 0.7% take profit, 0.3% stop loss (configurable)
- **No slippage**: Assumes perfect fills at signal prices
- **No commissions**: Does not account for trading costs

---

## Version 2.0 Enhancements

### New Features:
- âœ… VIX context integration (rank, percentile, plain-language summaries)
- âœ… 0DTE permission integrated into confidence logic
- âœ… Chop detector with 4-criteria analysis
- âœ… Time-of-day filters (lunch reduction, power hour boost, late-day cutoff)
- âœ… Market phase labeling (Pre-Market, Open Drive, Midday, Afternoon Drift, Power Hour, After Hours)
- âœ… Discord notifications for signal changes
- âœ… Enhanced chart (volume subplot, session markers, high/low of day)
- âœ… Regular hours filtering (9:30 AM - 4:00 PM ET only)
- âœ… EMA carryover from previous day
- âœ… Trade journal delete functionality
- âœ… **Summary sentences for all regime cards** (Trend Bias, Gap & Range, 0DTE Permission, Volatility Context)
- âœ… **Unified card styling** with CSS Grid layout for consistent equal-width cards
- âœ… **Restructured Signal section** matching Today's Regime card design

### Improvements:
- âœ… More accurate signal confidence (environment-aware)
- âœ… Better signal quality (chop detection reduces noise)
- âœ… Cleaner data (excludes pre-market/after-hours)
- âœ… Continuous indicators (EMA continuity)
- âœ… Better visualization (enhanced chart with session context)
- âœ… **Enhanced UI/UX**: Consistent card styling, improved spacing, better visual hierarchy
- âœ… **Contextual summaries**: Plain-language explanations for each regime card based on current market conditions
- âœ… **Color-coded borders**: Key cards (Trend Bias, 0DTE Permission, Signal) use dynamic colors; others use neutral grey
- âœ… **Equal-width layouts**: Signal and Rationale cards now match width and styling

---

## System Philosophy

**Rule-Based, Not Predictive**: The system identifies favorable setups based on quantifiable rules, not predictions. It tells you "conditions favor CALLs" not "price will go up."

**Multi-Factor Confirmation**: Signals require alignment across multiple dimensions:
- Daily trend (regime)
- Intraday momentum (micro trend)
- Volatility environment (IV/VIX)
- Time-of-day quality
- Market structure (chop vs. trending)

**Confidence Over Certainty**: Confidence levels (HIGH/MEDIUM/LOW) reflect setup quality, not guarantees. Even HIGH confidence signals can fail.

**System Adherence Tracking**: The journal helps you see if you're following the system or overriding it, and which approach is more profitable.

---

## Next Steps (Potential V3 Features)

- Position sizing recommendations based on confidence
- Strike selection logic for 0DTE options
- Exit timing signals (not just entry)
- Options pricing integration (Greeks, IV rank per strike)
- Multi-timeframe analysis (15-min, hourly context)
- Performance analytics (signal accuracy, best/worst times to trade)
- Automated trade logging (if broker API available)

