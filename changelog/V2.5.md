# SPY Trading Dashboard - Version 2.5

## System Overview

A comprehensive rule-based trading system for SPY 0DTE options and shares, combining daily regime analysis, intraday momentum, volatility context, and time-of-day filters. Features both a live dashboard for signal generation and a backtesting engine with Black-Scholes options pricing for historical validation.

---

## Core Components

### 1. **Live Dashboard** (Streamlit Cloud)
Real-time signal generation with multi-layer filtering and contextual analysis.

### 2. **Backtest Engine** (Options + Shares)
Historical validation using Black-Scholes pricing for 0DTE options or direct share price simulation.

### 3. **Trade Journal**
Manual trade logging with system adherence tracking and P/L analysis.

---

## Signal Generation Logic

### Base Signal Rules
- **CALL Signal**: Requires 3+ of:
  - Bullish daily trend (price > 20D MA)
  - Micro trend up (EMA 9 > EMA 21, price > VWAP)
  - Price above VWAP
  - Positive 5-bar return

- **PUT Signal**: Requires 3+ of:
  - Bearish daily trend (price < 20D MA)
  - Micro trend down (EMA 9 < EMA 21, price < VWAP)
  - Price below VWAP
  - Negative 5-bar return

- **Confidence Levels**:
  - **HIGH**: 4 matching conditions
  - **MEDIUM**: 3 matching conditions
  - **LOW**: 2 matching conditions

### Filter Stack (Applied in Order)

1. **Chop Detector**: Detects ranging markets (VWAP crosses, flat EMAs, low ATR)
2. **Time-of-Day Filters**: Adjusts confidence based on session (lunch reduction, power hour boost)
3. **Market Phase Gating**: Blocks signals during pre-market/after-hours
4. **Environment Filters**: Adjusts based on 0DTE permission and IV/VIX context
5. **Options Mode Filter** (Backtest only): Requires HIGH confidence + 1%+ move + IV > 12%

---

## Backtest Engine Architecture

### Entry Logic

#### **Options Mode**
- **Confidence Required**: Only **HIGH** confidence signals
- **Signal Types**: CALL or PUT (HIGH confidence only)
- **Entry Price**: Black-Scholes calculated option premium
- **Strike**: ATM (at-the-money) - rounds current price to nearest whole number
- **Additional Filters**:
  - Requires 1%+ underlying move (5-bar return)
  - Requires IV > 12% (uses VIX as proxy for historical backtests)
  - Only HIGH confidence signals pass

#### **Shares Mode**
- **Confidence Required**: **MEDIUM or HIGH** confidence signals
- **Signal Types**: CALL or PUT (MEDIUM or HIGH confidence)
- **Entry Price**: Underlying stock price directly
- **No additional filtering**: More lenient entry criteria

### Exit Logic

#### **Options Mode**
- **Take Profit**: 50% of premium paid
- **Stop Loss**: 50% of premium paid
- **EOD Exit**: 15:30 ET (forced close before market close)
- **Pricing**: Black-Scholes recalculated at each 5-min bar using:
  - Current underlying price
  - Time to expiration (0DTE, expires at 16:00)
  - Entry IV (VIX-based, held constant)
  - Risk-free rate: 5% annual

#### **Shares Mode**
- **Take Profit**: 0.7% of entry price
- **Stop Loss**: 0.3% of entry price
- **EOD Exit**: 15:30 ET

### Black-Scholes Implementation

**Option Pricing**:
- Uses `scipy.stats.norm` for cumulative distribution function
- Calculates theoretical option price based on:
  - S: Current underlying price
  - K: Strike price (ATM)
  - T: Time to expiration (in years, calculated from current time to 16:00)
  - r: Risk-free rate (5% annual)
  - Ïƒ: Implied volatility (VIX / 100)
  - Type: Call or Put

**Greeks Calculation**:
- Delta: Price sensitivity to underlying
- Gamma: Delta sensitivity to underlying
- Theta: Time decay (per day)
- Vega: IV sensitivity (per 1% IV change)

**P/L Calculation**:
- `PnL = (Exit_Price - Entry_Price) Ã— 100 Ã— Contracts`
- Each contract = 100 shares
- Default: 1 contract

---

## Data Architecture

### Data Sources
- **Primary**: Alpaca API (IEX feed, free tier)
- **Fallback**: yfinance (if Alpaca unavailable)
- **Backtest**: yfinance (historical 5-min bars)

### Data Fetching
- **Daily bars**: 80-day lookback (cached 5 min)
- **Intraday bars**: 5-min, last 2 days (cached 30 sec)
- **Regular hours only**: 9:30 AM - 4:00 PM ET
- **VIX context**: Cached 1 hour

### Historical VIX Context (Backtests)
- **VIX Level**: Uses **Open** price (not Close) to avoid look-ahead bias
- **VIX Rank**: Position within 252-day range
- **VIX Percentile**: Historical percentile
- **ATM IV Proxy**: Uses VIX level as proxy (historical option chain data unavailable)

---

## Key Fixes (V2.5)

### 1. **VIX Look-Ahead Bias Fix**
- **Issue**: Backtest used VIX Close price, allowing system to "know" end-of-day volatility
- **Fix**: Changed to VIX Open price for realistic intraday simulation
- **Impact**: More accurate backtest results, slightly worse performance (as expected)

### 2. **Missing ATM IV in Backtests**
- **Issue**: Historical ATM IV returned `None`, causing IV filters to be skipped
- **Fix**: Use VIX level as proxy for ATM IV in backtests
- **Impact**: IV filters now active during backtests (requires IV > 12% for options mode)

### 3. **Data Truncation Warning**
- **Issue**: Users saw confusing "EOD" exits when data was incomplete
- **Fix**: Added warning when last processed bar is before 15:30
- **Impact**: Users now alerted to data quality issues

### 4. **11:00 AM EOD Bug Fix**
- **Issue**: All trades exiting at 11:00 AM with "EOD" reason
- **Root Cause**: yfinance `end_date` parameter is **exclusive** - requesting data until 16:00 stopped before 16:00
- **Fix**: Extended `end_date` by 1 day to ensure full trading day data
- **Impact**: Backtest now processes full trading day (9:30 AM - 16:00 PM)

### 5. **Streamlit Cloud Cache Clearing**
- **Issue**: Users on Streamlit Cloud couldn't clear stale yfinance cache
- **Fix**: Added "ðŸ§¹ Clear Cache & Reboot" button to sidebar
- **Impact**: Users can now clear cache and force fresh data fetch

---

## Dashboard Features

### Real-Time Monitoring
- **Live data**: 5-minute bars, updates every 30 seconds
- **Auto-refresh**: Configurable (default: 30 seconds)
- **Discord notifications**: Alerts when signal direction/confidence changes
- **Data source indicator**: Shows whether using Alpaca or yfinance

### UI/UX
- **Unified card design**: Consistent styling with CSS Grid layout
- **Contextual summaries**: Plain-language explanations for each regime card
- **Color-coded borders**: Dynamic colors for key cards (Trend, Permission, Signal)
- **Enhanced chart**: Volume subplot, session markers, high/low of day
- **Cache controls**: Manual refresh and cache clearing buttons

### Trade Journal
- **Manual logging**: Timestamp, direction, bias, size, prices, notes
- **System adherence tracking**: "with-system" vs "against-system" tags
- **P/L analysis**: Total, system-aligned, and system-opposed P/L
- **Delete functionality**: Remove incorrect entries

---

## Backtest Metrics

### Performance Metrics
- **Number of Trades**: Total trades executed
- **Win Rate**: Percentage of profitable trades
- **Average R-Multiple**: Average profit/risk ratio
- **Max Drawdown**: Largest peak-to-trough decline
- **Total P/L**: Cumulative profit/loss
- **Time-of-Day Analysis**: Performance breakdown by session period

### Trade Data
- Entry/exit timestamps
- Direction (LONG/SHORT for options, CALL/PUT for shares)
- Entry/exit prices (option premium or share price)
- Entry/exit underlying prices
- Strike price (options only)
- P/L (dollars)
- Exit reason (TP/SL/EOD)
- R-multiple (profit/risk ratio)

---

## Configuration Parameters

### Backtest Parameters (Shares)
```python
BACKTEST_TP_PCT = 0.007   # Take profit: 0.7%
BACKTEST_SL_PCT = 0.003   # Stop loss: 0.3%
BACKTEST_POSITION_SIZE = 1.0  # Fixed position size
```

### Backtest Parameters (Options)
```python
BACKTEST_OPTIONS_TP_PCT = 0.50  # Take profit: 50% of premium
BACKTEST_OPTIONS_SL_PCT = 0.50  # Stop loss: 50% of premium
BACKTEST_OPTIONS_CONTRACTS = 1  # Number of contracts
BACKTEST_RISK_FREE_RATE = 0.05  # 5% annual
```

### Session Times
```python
SESSION_START = "09:45"  # First signal allowed
SESSION_END = "15:30"    # Last signal / forced exit
BLOCK_TRADE_AFTER = "15:30"  # No new entries after this
```

### Chop Detection
```python
CHOP_VWAP_CROSSES_THRESHOLD = 3  # VWAP crosses in last hour
CHOP_EMA_FLAT_THRESHOLD = 0.001  # EMA slope threshold (0.1%)
CHOP_ATR_THRESHOLD = 0.002  # ATR below this = chop (0.2%)
CHOP_VWAP_RANGE_THRESHOLD = 0.002  # Range inside VWAP Â±0.2%
```

---

## Limitations & Considerations

### Dashboard Limitations
- **No position sizing**: Signals indicate direction/confidence, not size
- **No strike selection**: Does not recommend specific strikes
- **No exit timing**: Signals indicate entry bias, not exit points
- **Manual execution**: All trades must be executed manually

### Backtest Limitations
- **Fixed TP/SL**: No dynamic exit optimization
- **No trailing stops**: Exits are static percentage-based
- **No slippage**: Assumes perfect fills at signal prices
- **No commissions**: Does not account for trading costs
- **Constant IV**: Uses entry IV throughout trade (no IV changes)
- **5-min bars**: Fastest granularity (not tick-by-tick)

### Data Limitations
- **5-minute bars**: Not 1-minute or tick data
- **Free tier**: Alpaca IEX feed (sufficient for 5-min)
- **Historical IV**: ATM IV not available for backtests (VIX proxy used)
- **Cache dependency**: Stale cache can cause data truncation issues

---

## System Philosophy

**Rule-Based, Not Predictive**: Identifies favorable setups based on quantifiable rules, not predictions.

**Multi-Factor Confirmation**: Signals require alignment across:
- Daily trend (regime)
- Intraday momentum (micro trend)
- Volatility environment (IV/VIX)
- Time-of-day quality
- Market structure (chop vs. trending)

**Confidence Over Certainty**: Confidence levels reflect setup quality, not guarantees.

**Backtest as Baseline**: Backtest results represent "dumb money" approach with fixed rules. Active management should improve on this.

**Options vs Shares**: Options mode is more selective (HIGH confidence only) but offers higher leverage. Shares mode is more frequent (MEDIUM+ confidence) but lower risk.

---

## Version History

### V2.5 (Current)
- âœ… Fixed VIX look-ahead bias (use Open instead of Close)
- âœ… Fixed missing ATM IV in backtests (use VIX as proxy)
- âœ… Added data truncation warning
- âœ… Fixed 11:00 AM EOD bug (extended data fetch window)
- âœ… Added Streamlit Cloud cache clearing button
- âœ… Improved backtest data integrity checks

### V2.0
- âœ… VIX context integration
- âœ… 0DTE permission system
- âœ… Chop detector
- âœ… Time-of-day filters
- âœ… Market phase labeling
- âœ… Discord notifications
- âœ… Enhanced chart
- âœ… Regular hours filtering
- âœ… EMA carryover
- âœ… Unified card styling
- âœ… Contextual summaries

### V1.0
- âœ… Basic regime analysis
- âœ… Intraday analysis (VWAP, EMA)
- âœ… Signal generation
- âœ… Trade journal
- âœ… Basic backtesting

---

## Next Steps (Potential V3 Features)

- Dynamic exit optimization (trailing stops, technical exits)
- Position sizing recommendations based on confidence
- Strike selection logic for 0DTE options
- Multi-timeframe analysis (15-min, hourly context)
- Performance analytics (signal accuracy, best/worst times)
- Options Greeks display in dashboard
- Automated trade logging (if broker API available)
- Real-time options pricing (if options data feed available)

---

## Usage Recommendations

### For Live Trading (Dashboard)
1. **Options traders**: Only take HIGH confidence signals
2. **Shares traders**: Can take MEDIUM or HIGH confidence signals
3. **Check 0DTE Permission**: Avoid RED days for options
4. **Verify IV**: Ensure IV > 12% for options trades
5. **Respect time filters**: Avoid lunch period and late-day signals

### For Backtesting
1. **Clear cache first**: Use "ðŸ§¹ Clear Cache & Reboot" button
2. **Options mode**: Expect fewer trades, higher selectivity
3. **Shares mode**: More trades, lower leverage
4. **Interpret results**: Backtest is baseline, not ceiling
5. **Check data quality**: Watch for truncation warnings

### For System Development
1. **Test changes in backtest first**: Validate logic before live use
2. **Monitor signal quality**: Track win rate and R-multiples
3. **Adjust filters carefully**: Small changes can have big impacts
4. **Document changes**: Keep changelog updated
5. **Version control**: Commit changes to GitHub

---

## Technical Stack

- **Frontend**: Streamlit (Python web framework)
- **Data**: Alpaca API, yfinance
- **Hosting**: Streamlit Cloud (24/7 uptime)
- **Notifications**: Discord webhooks
- **Options Pricing**: Black-Scholes (scipy)
- **Caching**: Streamlit cache decorators
- **Version Control**: Git/GitHub

---

## Contact & Support

- **GitHub**: [aidanaimy/spy-dashboard](https://github.com/aidanaimy/spy-dashboard)
- **Dashboard**: Hosted on Streamlit Cloud
- **Updates**: Check changelog for version history
